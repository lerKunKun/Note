
# 跨境电商业务中台 (E-commerce Middle Platform) PRD

| 文档属性 | 内容 |
| :--- | :--- |
| **项目名称** | 跨境电商业务中台 (EMP) |
| **文档版本** | V1.0 (Draft) |
| **撰写日期** | 2025-12-08 |
| **文档状态** | 待评审 |
| **面向对象** | 开发团队、架构师、产品经理 |

---

## 1. 项目背景与目标
**背景**：
当前跨境电商业务面临多店铺管理复杂（Shopify）、环境隔离要求高（HubStudio 防关联）、供应链与财务数据割裂等痛点。现有操作依赖人工跨系统切换，效率低且存在账号安全风险。

**核心目标**：
1.  **统一入口**：集成 DingTalk 扫码登录，一站式管理所有业务。
2.  **权限中台化**：基于 **Casbin Server** 构建中心化鉴权，实现细粒度的 RBAC 权限控制。
3.  **安全环境隔离**：深度集成 HubStudio API，通过中台调度指纹浏览器，保障店铺账号安全。
4.  **数据闭环**：打通 "采购 -> 刊登 -> 订单 -> 物流 -> 财务" 全链路数据流。

---

## 2. 总体技术架构 (Architecture)

### 2.1 技术选型
*   **前端 (Frontend)**: Vue.js / React (Ant Design Pro)
*   **后端业务 (Backend)**: Python (FastAPI/Django) 或 Java (Spring Boot)
*   **权限中心 (Auth)**: **Casbin Server (Go/Rust)** - 独立部署，提供 gRPC 鉴权服务。
*   **数据库 (DB)**: MySQL (业务数据) + Redis (缓存/会话) + Etcd/Redis (Casbin 策略同步)。

### 2.2 关键集成
*   **DingTalk API**: 身份认证、组织架构同步。
*   **Shopify API**: 商品刊登、订单同步、物流回传。
*   **HubStudio Local API**: 唤起本地环境、环境状态监控。

---

## 3. 用户角色 (User Roles)

| 角色 | 职责描述 | 核心权限示例 |
| :--- | :--- | :--- |
| **超级管理员** | 系统整体配置、策略管理 | `*` (All Permissions) |
| **运营人员** | 产品开发、上架、店铺维护 | `p, role:ops, /api/product, write` |
| **供应链/采购** | 采购下单、供应商管理 | `p, role:purchase, /api/supply, write` |
| **物流专员** | 运单配对、发货操作 | `p, role:logistics, /api/shipping, write` |
| **财务人员** | 成本录入、利润核算 | `p, role:finance, /api/report, read` |

---

## 4. 功能模块详解 (Functional Requirements)

### 4.1 🔐 身份认证与权限管理 (Auth & IAM - Casbin Enhanced)
> **架构策略**：认证 (Authentication) 与 鉴权 (Authorization) 分离。DingTalk 负责认证，Casbin 负责鉴权。

| 功能点 | 详细需求描述 | 优先级 |
| :--- | :--- | :--- |
| **DingTalk 扫码登录** | 1. 集成 DingTalk 扫码/免登。<br>2. **自动注册/白名单**：登录时校验用户是否在企业白名单/部门内。是则自动创建账号并关联钉钉 ID，否则拒绝。 | P0 |
| **Casbin 策略管理** | **可视化权限配置台**：<br>1. 管理角色 (Role) 与用户 (User) 的继承关系 (g)。<br>2. 配置访问策略 (p)：`Subject, Object, Action`。<br>3. 支持策略热加载 (Watcher 机制)，修改即生效。 | P0 |
| **权限中间件 (Middleware)** | 在 API Gateway 或业务层拦截请求，提取 `sub (user/role)`, `obj (url)`, `act (method)`，调用 Casbin Server `Enforce` 接口进行鉴权。 | P0 |
| **HubStudio 账号绑定** | 每个中台账号需强制绑定唯一的 HubStudio Team ID / User ID，用于后续环境调用鉴权与日志溯源。 | P1 |
| **安全审计** | 1. **操作日志**：记录 Who, When, What (Diff), IP。<br>2. **页面水印**：全屏显示“姓名+工号”斜纹水印，防止截图泄密。 | P1 |

### 4.2 📦 产品库系统 (PIM)
> **目标**：实现“一次编辑，多端适配，一键刊登”。

| 功能点 | 详细需求描述 | 优先级 |
| :--- | :--- | :--- |
| **产品资料管理 (CRUD)** | 字段包含：SPU/SKU、中英文名、采购链接、参考竞品 URL、多图管理、预设分类。 | P0 |
| **详情页模板引擎** | 1. **JSON 模板库**：存储 Shopify Section/Block 结构的 JSON 片段。<br>2. **智能匹配**：根据目标店铺/平台，自动组装对应的 JSON 模板。<br>3. **版本管理**：记录详情页版本号 (v1.0, v2.0)，支持一键回滚。 | P0 |
| **一键刊登 (Listing)** | 流程：选择产品 -> 勾选店铺 (支持多选) -> 渲染模板 -> 调用 Shopify API 推送 -> 返回 Shopify Product ID。 | P0 (MVP) |
| **数据导入导出** | 支持通用 CSV 导入产品池；支持导出适配 Shopify 格式的 CSV 包。 | P1 |

### 4.3 🚚 订单与物流系统 (OMS)
> **目标**：自动化订单处理，兼顾高风险店铺的环境安全。

| 功能点 | 详细需求描述 | 优先级 |
| :--- | :--- | :--- |
| **订单同步 (Sync)** | 配置 Shopify Webhook (`orders/create`, `orders/updated`)，实时将订单落库至中台。 | P0 |
| **运单管理** | 运单列表展示，支持手动输入或批量导入物流单号，与 Shopify 订单号绑定。 | P0 |
| **HubStudio 物流回传** | **混合回传模式**：<br>1. **API 直连**：普通店铺直接调用 Shopify Fulfillment API。<br>2. **环境安全模式 (重点)**：针对风控店铺，中台调用 HubStudio API 唤起指纹浏览器 -> 脚本/人工介入回传 -> 避免服务器 IP 关联。 | P0 |
| **测试闭环** | 提供“创建测试订单”按钮，模拟从下单到抓取、再到回传的全流程，用于系统自检。 | P1 |

### 4.4 🏭 供应链与采购系统 (SCM)
> **目标**：规范采购动作，沉淀成本数据。

| 功能点 | 详细需求描述 | 优先级 |
| :--- | :--- | :--- |
| **采购需求池** | 系统根据订单缺货情况或安全库存预警，自动生成建议采购清单。 | P1 |
| **采购流程管理** | 状态机：`草稿` -> `审批中` (Casbin控制权限) -> `已下单` -> `部分入库` -> `完成`。 | P1 |
| **合同与模版** | 内置采购合同模板，支持填充变量（供应商、金额、日期）生成 PDF。 | P2 |

### 4.5 🖥️ Hub 环境管理系统
> **目标**：无需切换软件，在中台直接控制浏览器。

| 功能点 | 详细需求描述 | 优先级 |
| :--- | :--- | :--- |
| **环境列表同步** | 拉取 HubStudio 环境数据（ID、名称、备注、代理状态）。 | P1 |
| **一键启动** | 点击“启动”，调用 Local API 打开对应的指纹浏览器窗口。 | P1 |
| **API 状态监控** | 监控 HubStudio 插件/服务连接状态，异常报警。 | P2 |

### 4.6 📢 广告与媒体库 (Ads & DAM)
| 功能点 | 详细需求描述 | 优先级 |
| :--- | :--- | :--- |
| **媒体资源库** | 集中存储图片、视频素材，支持标签化管理（用于广告和详情页）。 | P1 |
| **像素助手** | 一键生成/安装 Facebook/TikTok Pixel 代码。 | P2 |
| **API 数据接入** | 对接 FB Marketing API，拉取广告花费数据（用于财务计算）。 | P2 |

### 4.7 💰 财务管理系统 (Finance)
| 功能点 | 详细需求描述 | 优先级 |
| :--- | :--- | :--- |
| **利润报表** | 维度：按店铺、按 SKU、按日期。<br>公式：`销售额 - 采购成本 - 头程/尾程运费 - 广告费 - 平台佣金 = 毛利`。 | P1 |

---

## 5. 非功能性需求 (NFR)

1.  **性能**：
    *   Casbin 鉴权响应时间 < 20ms。
    *   Webhook 订单同步处理延迟 < 5s。
2.  **安全性**：
    *   API 接口全量鉴权。
    *   敏感配置（Shopify Token, Hub API Key）加密存储。
    *   内网穿透/IP 白名单访问限制。
3.  **兼容性**：
    *   核心流程适配主流浏览器（Chrome/Edge）。
    *   移动端（H5）适配核心审批与报表查看。

---

## 6. MVP (最小可行性产品) 实施路线图

**Phase 1: 核心链路打通 (预计周期: 4-6周)**
1.  **基建**：部署 Casbin Server，完成 DingTalk 扫码登录与基础 RBAC 配置。
2.  **商品**：完成产品库 CRUD，实现 JSON 模板化的一键刊登。
3.  **订单**：跑通 Shopify Webhook 抓单，实现 HubStudio 环境下的运单回传。

**Phase 2: 业务闭环与提效 (预计周期: 4周)**
1.  **采购**：上线采购流程与合同管理。
2.  **财务**：上线基础利润报表。
3.  **安全**：完善日志审计与水印系统。

